<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Preview</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        img { max-width: 300px; border: 1px solid #ddd; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Debug Image Preview</h1>
    
    <div class="test-section">
        <h2>Test 1: Server Status Check</h2>
        <button onclick="checkServer()">Check Server Status</button>
        <div id="server-status"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Direct URL (without token)</h2>
        <p>URL: <code>http://localhost:4000/api/files/BondanP_1234wer53.png/stream</code></p>
        <img id="img1" src="http://localhost:4000/api/files/BondanP_1234wer53.png/stream"
             alt="Test 1" onload="showSuccess('test1')" onerror="showError('test1', this.src)">
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: With Token</h2>
        <button onclick="getToken()" style="margin-bottom: 10px;">Get Token</button><br>
        <input type="text" id="tokenInput" placeholder="Token will appear here" style="width: 400px;">
        <button onclick="testWithToken()">Test with Token</button>
        <div id="test2-result"></div>
        <img id="img2" style="display: none;" onload="showSuccess('test2')" onerror="showError('test2', this.src)">
    </div>

    <div class="test-section">
        <h2>Test 4: SVG File (with token)</h2>
        <button onclick="testSVG()" style="margin-bottom: 10px;">Test SVG with Token</button>
        <div id="test3-result"></div>
        <img id="img3" style="display: none;" onload="showSuccess('test3')" onerror="showError('test3', this.src)">
    </div>

    <script>
        function showSuccess(testId) {
            document.getElementById(testId + '-result').innerHTML = '<span class="success">‚úÖ Image loaded successfully!</span>';
        }

        function showError(testId, url) {
            document.getElementById(testId + '-result').innerHTML = 
                '<span class="error">‚ùå Failed to load image</span><br>' +
                '<small>URL: ' + url + '</small>';
        }

        function testWithToken() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                alert('Please enter a token');
                return;
            }

            const url = `http://localhost:4000/api/files/BondanP_1234wer53.png/stream?token=${encodeURIComponent(token)}`;
            const img = document.getElementById('img2');
            img.src = url;
            img.style.display = 'block';
            
            document.getElementById('test2-result').innerHTML =
                '<p>Testing URL: <code>' + url + '</code></p>';
        }

        // Test SVG with token
        function testSVG() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                alert('Please get token first');
                return;
            }

            const url = `http://localhost:4000/api/files/test_circle.svg/stream?token=${encodeURIComponent(token)}`;
            const img = document.getElementById('img3');
            img.src = url;
            img.style.display = 'block';

            document.getElementById('test3-result').innerHTML =
                '<p>Testing SVG URL: <code>' + url + '</code></p>';
        }

        // Check server status
        async function checkServer() {
            document.getElementById('server-status').innerHTML =
                '<span style="color: blue;">üîÑ Checking server...</span>';

            try {
                const response = await fetch('http://localhost:4000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('server-status').innerHTML =
                        '<span class="success">‚úÖ Server is running: ' + JSON.stringify(data) + '</span>';
                } else {
                    document.getElementById('server-status').innerHTML =
                        '<span class="error">‚ùå Server responded with: ' + response.status + '</span>';
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML =
                    '<span class="error">‚ùå Server not reachable: ' + error.message + '</span>';
            }
        }

        // Get token manually
        async function getToken() {
            document.getElementById('test2-result').innerHTML =
                '<span style="color: blue;">üîÑ Getting token...</span>';

            try {
                const response = await fetch('http://localhost:4000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Admin@123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('tokenInput').value = data.accessToken;
                    document.getElementById('test2-result').innerHTML =
                        '<span class="success">‚úÖ Token obtained successfully!</span>';
                } else {
                    const errorText = await response.text();
                    document.getElementById('test2-result').innerHTML =
                        '<span class="error">‚ùå Failed to get token: ' + response.status + '<br>' + errorText + '</span>';
                }
            } catch (error) {
                document.getElementById('test2-result').innerHTML =
                    '<span class="error">‚ùå Error getting token: ' + error.message + '</span>';
            }
        }
    </script>
</body>
</html>
